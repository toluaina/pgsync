# This is a template deployment file for deploying PGSync on
# DigitalOcean's App Platform.
spec:
  name: pgsync-demo
  services:
    - name: pgsync
      environment_slug: python
      git:
        repo_clone_url: https://github.com/toluaina/pgsync.git
        branch: main
      # keep only an internal health port
      internal_ports: [9090]
      health_check:
        port: 9090

      build_command: pip install --no-cache-dir pgsync
      run_command: >-
        bash -lc 'pgsync --schema_url "${SCHEMA_URL}" -b -d &
        python -m http.server 9090'

      envs:
        - key: SCHEMA_URL
          value: https://raw.githubusercontent.com/toluaina/pgsync/main/examples/book/schema.json
          scope: RUN_TIME

        - key: PG_URL
          value: ${pg.DATABASE_URL}
          scope: RUN_TIME
        # Fill these during the wizard (OpenSearch + Valkey)
        - key: ELASTICSEARCH_URL    # e.g. https://user:pass@os-host:443
          scope: RUN_TIME
        - key: REDIS_URL           # e.g. rediss://default:pass@host:port/0
          scope: RUN_TIME
        - key: REDIS_CHECKPOINT
          value: "true"
          scope: RUN_TIME
        - key: OPENSEARCH
          value: "true"
          scope: RUN_TIME

  # NB: README button can add exactly one Dev Postgres :(
  databases:
    - name: pg
